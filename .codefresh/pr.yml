version: '1.0'

steps:

  build_image:
    type: build
    image_name: cfdemoacc/superapp
    working_directory: ${{main_clone}}/app/

  push_image:
    type: push
    candidate: '${{build_image}}'
    tag: 'pr-${{CF_PULL_REQUEST_NUMBER}}'
    registry: dockerhub

  deploy_chart:
    image: cablespaghetti/helmfile-docker:0.0.3
    working_directory: ${{main_clone}}/deploy/
    commands:
      - kubectl config use-context "$KUBE_CONTEXT"
      - export RELEASE_NAME="pr-${{CF_PULL_REQUEST_NUMBER}}"
      - helmfile apply